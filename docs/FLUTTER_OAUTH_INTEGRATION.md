# Flutter OAuth Integration Guide

## Overview

This guide shows how to integrate OAuth callback handling in your Flutter app to work with the fixed native implementations.

## Required Dependencies

Add to your `pubspec.yaml`:

```yaml
dependencies:
  app_links: ^6.0.0  # For handling deep links
  # Or alternatively:
  # uni_links: ^0.5.1
```

## Deep Link Configuration

### Android - Already Configured

Your `android/app/src/main/AndroidManifest.xml` should have:

```xml
<intent-filter android:autoVerify="true">
    <action android:name="android.intent.action.VIEW" />
    <category android:name="android.intent.category.DEFAULT" />
    <category android:name="android.intent.category.BROWSABLE" />
    <data android:scheme="eudi-openid4ci" android:host="authorize" />
</intent-filter>
```

### iOS - Already Configured

Your `ios/Runner/Info.plist` should have:

```xml
<key>CFBundleURLTypes</key>
<array>
    <dict>
        <key>CFBundleURLSchemes</key>
        <array>
            <string>eudi-openid4ci</string>
        </array>
    </dict>
</array>
```

## Flutter Implementation

### 1. Setup Deep Link Listener

Create a service to handle deep links (e.g., `lib/services/deep_link_service.dart`):

```dart
import 'dart:async';
import 'package:app_links/app_links.dart';
import 'package:flutter/foundation.dart';

class DeepLinkService {
  final _appLinks = AppLinks();
  StreamSubscription<Uri>? _linkSubscription;

  // Callback when authorization deep link is received
  Function(Uri)? onAuthorizationCallback;

  Future<void> initialize() async {
    // Handle initial deep link if app was opened by it
    try {
      final initialUri = await _appLinks.getInitialLink();
      if (initialUri != null) {
        _handleDeepLink(initialUri);
      }
    } catch (e) {
      debugPrint('Failed to get initial link: $e');
    }

    // Listen for deep links while app is running
    _linkSubscription = _appLinks.uriLinkStream.listen(
      _handleDeepLink,
      onError: (err) {
        debugPrint('Deep link error: $err');
      },
    );
  }

  void _handleDeepLink(Uri uri) {
    debugPrint('Received deep link: $uri');

    // Check if it's an OAuth authorization callback
    if (uri.scheme == 'eudi-openid4ci' && uri.host == 'authorize') {
      debugPrint('OAuth authorization callback detected');
      onAuthorizationCallback?.call(uri);
    }
  }

  void dispose() {
    _linkSubscription?.cancel();
  }
}
```

### 2. Integrate with SSI Service

Update your SSI service to handle OAuth flow (e.g., `lib/services/ssi_service.dart`):

```dart
import 'package:flutter/foundation.dart';
import '../pigeon/ssi_api.g.dart';  // Generated by Pigeon

class SsiService {
  final SsiApi _ssiApi;
  final DeepLinkService _deepLinkService;

  // Track if we're waiting for OAuth callback
  bool _isWaitingForOAuthCallback = false;
  Completer<bool>? _oauthCompleter;

  SsiService(this._ssiApi, this._deepLinkService) {
    // Listen for OAuth callbacks
    _deepLinkService.onAuthorizationCallback = _handleAuthorizationCallback;
  }

  /// Accept a credential offer
  /// This may trigger OAuth authorization flow
  Future<CredentialDto?> acceptCredentialOffer(
    String offerId,
    String? holderDidId,
  ) async {
    try {
      debugPrint('Accepting credential offer: $offerId');

      // Call native implementation
      // On Android, this will:
      // 1. Create OpenId4VciManager
      // 2. Call issueDocumentByOfferUri
      // 3. If authorization required, SDK opens browser
      // 4. Return here and wait for callback
      final credential = await _ssiApi.acceptCredentialOffer(
        offerId,
        holderDidId,
      );

      return credential;
    } catch (e) {
      // Check if this is an authorization required error
      if (e.toString().contains('authorization') ||
          e.toString().contains('OAuth')) {
        debugPrint('Authorization required, waiting for callback...');
        _isWaitingForOAuthCallback = true;

        // Wait for OAuth callback
        _oauthCompleter = Completer<bool>();
        final success = await _oauthCompleter!.future
            .timeout(Duration(minutes: 5), onTimeout: () => false);

        _isWaitingForOAuthCallback = false;
        _oauthCompleter = null;

        if (!success) {
          throw Exception('OAuth authorization failed or timed out');
        }

        // After successful OAuth, credential should be available
        // You may need to call getCredentials() to fetch it
        debugPrint('OAuth completed, fetching credentials...');
        final credentials = await _ssiApi.getCredentials();
        return credentials.isNotEmpty ? credentials.first : null;
      }

      rethrow;
    }
  }

  /// Handle OAuth authorization callback from deep link
  Future<void> _handleAuthorizationCallback(Uri uri) async {
    debugPrint('Handling OAuth callback: $uri');

    if (!_isWaitingForOAuthCallback) {
      debugPrint('Not waiting for OAuth callback, ignoring');
      return;
    }

    try {
      // Call native handler via Pigeon
      final success = await _ssiApi.handleAuthorizationCallback(
        uri.toString(),
      );

      debugPrint('OAuth callback handled: success=$success');

      // Complete the OAuth flow
      _oauthCompleter?.complete(success);
    } catch (e) {
      debugPrint('Error handling OAuth callback: $e');
      _oauthCompleter?.completeError(e);
    }
  }
}
```

### 3. UI Integration

Example credential issuance screen with OAuth handling:

```dart
import 'package:flutter/material.dart';

class CredentialOfferScreen extends StatefulWidget {
  final String offerUrl;

  const CredentialOfferScreen({
    Key? key,
    required this.offerUrl,
  }) : super(key: key);

  @override
  State<CredentialOfferScreen> createState() => _CredentialOfferScreenState();
}

class _CredentialOfferScreenState extends State<CredentialOfferScreen> {
  bool _isLoading = false;
  String? _errorMessage;
  CredentialDto? _credential;

  Future<void> _acceptOffer() async {
    setState(() {
      _isLoading = true;
      _errorMessage = null;
    });

    try {
      // Get SSI service (from DI/service locator)
      final ssiService = serviceLocator<SsiService>();

      // This will handle OAuth automatically if needed
      final credential = await ssiService.acceptCredentialOffer(
        widget.offerUrl,
        null, // holderDidId
      );

      setState(() {
        _credential = credential;
        _isLoading = false;
      });

      if (credential != null) {
        // Show success message
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('Credential issued successfully!')),
        );

        // Navigate to credential detail or dashboard
        Navigator.of(context).pop(credential);
      }
    } catch (e) {
      setState(() {
        _errorMessage = e.toString();
        _isLoading = false;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('Credential Offer')),
      body: Padding(
        padding: const EdgeInsets.all(16.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.stretch,
          children: [
            if (_isLoading) ...[
              Center(child: CircularProgressIndicator()),
              SizedBox(height: 16),
              Text(
                'Processing credential offer...\n'
                'If authorization is required, a browser window will open.',
                textAlign: TextAlign.center,
                style: TextStyle(color: Colors.grey[600]),
              ),
            ] else if (_errorMessage != null) ...[
              Icon(Icons.error_outline, color: Colors.red, size: 48),
              SizedBox(height: 16),
              Text(
                _errorMessage!,
                textAlign: TextAlign.center,
                style: TextStyle(color: Colors.red),
              ),
              SizedBox(height: 16),
              ElevatedButton(
                onPressed: _acceptOffer,
                child: Text('Retry'),
              ),
            ] else if (_credential != null) ...[
              Icon(Icons.check_circle, color: Colors.green, size: 48),
              SizedBox(height: 16),
              Text(
                'Credential issued!',
                textAlign: TextAlign.center,
                style: Theme.of(context).textTheme.titleLarge,
              ),
            ] else ...[
              Text(
                'Accept this credential offer?',
                style: Theme.of(context).textTheme.titleLarge,
              ),
              SizedBox(height: 8),
              Text(
                'Offer URL: ${widget.offerUrl}',
                style: TextStyle(color: Colors.grey[600], fontSize: 12),
              ),
              SizedBox(height: 24),
              ElevatedButton(
                onPressed: _acceptOffer,
                child: Text('Accept Offer'),
              ),
            ],
          ],
        ),
      ),
    );
  }
}
```

### 4. App Initialization

In your `main.dart` or app setup:

```dart
void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  // Initialize deep link service
  final deepLinkService = DeepLinkService();
  await deepLinkService.initialize();

  // Initialize SSI API
  final ssiApi = SsiApi();

  // Initialize SSI service
  final ssiService = SsiService(ssiApi, deepLinkService);

  // Register in service locator (if using get_it or similar)
  serviceLocator.registerSingleton(deepLinkService);
  serviceLocator.registerSingleton(ssiApi);
  serviceLocator.registerSingleton(ssiService);

  runApp(MyApp());
}
```

## OAuth Flow Sequence

```
┌─────────┐         ┌─────────┐         ┌─────────┐         ┌─────────┐
│ Flutter │         │ Native  │         │ Browser │         │ Issuer  │
│   UI    │         │   SDK   │         │         │         │ Server  │
└────┬────┘         └────┬────┘         └────┬────┘         └────┬────┘
     │                   │                   │                   │
     │ Accept Offer      │                   │                   │
     ├──────────────────>│                   │                   │
     │                   │                   │                   │
     │                   │ Open Authorization│                   │
     │                   ├──────────────────>│                   │
     │                   │                   │                   │
     │                   │                   │ Authorize Request │
     │                   │                   ├──────────────────>│
     │                   │                   │                   │
     │                   │                   │ Show Login/Consent│
     │                   │                   │<──────────────────┤
     │                   │                   │                   │
     │                   │  Redirect w/ code │                   │
     │                   │<──────────────────┤                   │
     │  Deep Link        │                   │                   │
     │<──────────────────┤                   │                   │
     │                   │                   │                   │
     │ handleAuthCallback│                   │                   │
     ├──────────────────>│                   │                   │
     │                   │                   │                   │
     │                   │ Exchange code for token + credential  │
     │                   ├──────────────────────────────────────>│
     │                   │                   │                   │
     │                   │         Credential + metadata         │
     │                   │<──────────────────────────────────────┤
     │  Credential       │                   │                   │
     │<──────────────────┤                   │                   │
     │                   │                   │                   │
```

## Platform-Specific Notes

### Android
- ✅ Full OAuth support with EUDI Android SDK
- Browser opens automatically via SDK
- Callbacks handled via `resumeWithAuthorization()`
- App state preserved during OAuth flow

### iOS
- ⚠️ Currently uses mock implementation
- OAuth not functional until real EUDI iOS SDK is integrated
- Will use ASWebAuthenticationSession when integrated
- No manual callback handling needed with real SDK

## Testing Tips

1. **Test with real issuer**: Use https://issuer.eudiw.dev for testing
2. **Check logs**: Monitor both Flutter and native logs during OAuth
3. **Test app killed**: Kill app during OAuth to test state recovery
4. **Test denial**: Test when user denies authorization
5. **Test timeout**: Test when user doesn't complete authorization

## Debugging

Enable verbose logging:

```dart
// In deep link service
debugPrint('Deep link received: $uri');
debugPrint('Query params: ${uri.queryParameters}');

// In SSI service
debugPrint('Calling native acceptCredentialOffer');
debugPrint('Waiting for OAuth callback...');
debugPrint('OAuth callback received and handled');
```

Check native logs:
```bash
# Android
adb logcat | grep -E "EudiSsiApiImpl|MainActivity"

# iOS
# View Xcode console or:
log stream --predicate 'subsystem == "com.example.ssi"'
```

## Common Issues

### Deep link not received
- Check app is registered for `eudi-openid4ci://` scheme
- Verify AndroidManifest.xml / Info.plist configuration
- Test deep link manually: `adb shell am start -W -a android.intent.action.VIEW -d "eudi-openid4ci://authorize?code=test"`

### OAuth timeout
- Increase timeout duration
- Check network connectivity
- Verify issuer server is reachable

### State lost after OAuth
- Android: Manager instance lost (app killed) - implemented error handling
- iOS: N/A (mock implementation)
- Solution: Implement state persistence if needed

## Next Steps

1. Test the integration with a real EUDI credential issuer
2. Implement error handling and retry logic
3. Add analytics/logging for OAuth flow tracking
4. For iOS: Integrate real EUDI iOS SDK once available
